use challenges ;

drop table if exists order_fact ;

create table order_fact (
	`order_id` int auto_increment,
	`order_status` varchar(15),
	`order_date` date,
	primary key (`order_id`)
) ;

insert into order_fact (order_status, order_date) values ('cancelled', '2023-01-01'), ('returned', '2023-01-02'), ('returned', '2023-01-03'), ('returned', '2023-01-04'), ('approved', '2023-01-05'), ('delivered', '2023-01-06'), ('returned', '2023-01-07'), ('delivered', '2023-01-08'), ('cancelled', '2023-01-09'), ('delivered', '2023-01-10'), ('cancelled', '2023-01-11'), ('cancelled', '2023-01-12'), ('cancelled', '2023-01-13'), ('returned', '2023-01-14'), ('cancelled', '2023-01-15'), ('cancelled', '2023-01-16'), ('delivered', '2023-01-17'), ('cancelled', '2023-01-18'), ('approved', '2023-01-19'), ('returned', '2023-01-20'), ('delivered', '2023-01-21'), ('approved', '2023-01-22'), ('returned', '2023-01-23'), ('delivered', '2023-01-24'), ('returned', '2023-01-25'), ('approved', '2023-01-26'), ('delivered', '2023-01-27'), ('cancelled', '2023-01-28'), ('cancelled', '2023-01-29'), ('cancelled', '2023-01-30'), ('returned', '2023-01-31'), ('returned', '2023-02-01'), ('cancelled', '2023-02-02'), ('delivered', '2023-02-03'), ('delivered', '2023-02-04'), ('approved', '2023-02-05'), ('cancelled', '2023-02-06'), ('cancelled', '2023-02-07'), ('cancelled', '2023-02-08'), ('delivered', '2023-02-09'), ('approved', '2023-02-10'), ('cancelled', '2023-02-11'), ('approved', '2023-02-12'), ('returned', '2023-02-13'), ('delivered', '2023-02-14'), ('returned', '2023-02-15'), ('returned', '2023-02-16'), ('approved', '2023-02-17'), ('cancelled', '2023-02-18'), ('delivered', '2023-02-19'), ('cancelled', '2023-02-20'), ('returned', '2023-02-21'), ('returned', '2023-02-22'), ('approved', '2023-02-23'), ('returned', '2023-02-24'), ('cancelled', '2023-02-25'), ('delivered', '2023-02-26'), ('cancelled', '2023-02-27'), ('approved', '2023-02-28'), ('cancelled', '2023-03-01'), ('cancelled', '2023-03-02'), ('cancelled', '2023-03-03'), ('cancelled', '2023-03-04'), ('returned', '2023-03-05'), ('delivered', '2023-03-06'), ('approved', '2023-03-07'), ('delivered', '2023-03-08'), ('cancelled', '2023-03-09'), ('returned', '2023-03-10'), ('delivered', '2023-03-11'), ('approved', '2023-03-12'), ('delivered', '2023-03-13'), ('delivered', '2023-03-14'), ('cancelled', '2023-03-15'), ('cancelled', '2023-03-16'), ('cancelled', '2023-03-17'), ('delivered', '2023-03-18'), ('returned', '2023-03-19'), ('returned', '2023-03-20'), ('delivered', '2023-03-21'), ('approved', '2023-03-22'), ('cancelled', '2023-03-23'), ('delivered', '2023-03-24'), ('cancelled', '2023-03-25'), ('delivered', '2023-03-26'), ('delivered', '2023-03-27'), ('delivered', '2023-03-28'), ('approved', '2023-03-29'), ('returned', '2023-03-30'), ('delivered', '2023-03-31'), ('approved', '2023-04-01'), ('cancelled', '2023-04-02'), ('cancelled', '2023-04-03'), ('approved', '2023-04-04'), ('delivered', '2023-04-05'), ('approved', '2023-04-06'), ('cancelled', '2023-04-07'), ('delivered', '2023-04-08'), ('cancelled', '2023-04-09'), ('cancelled', '2023-04-10'), ('cancelled', '2023-04-11'), ('returned', '2023-04-12'), ('cancelled', '2023-04-13'), ('approved', '2023-04-14'), ('approved', '2023-04-15'), ('returned', '2023-04-16'), ('returned', '2023-04-17'), ('cancelled', '2023-04-18'), ('returned', '2023-04-19'), ('delivered', '2023-04-20'), ('delivered', '2023-04-21'), ('cancelled', '2023-04-22'), ('cancelled', '2023-04-23'), ('returned', '2023-04-24'), ('cancelled', '2023-04-25'), ('approved', '2023-04-26'), ('cancelled', '2023-04-27'), ('cancelled', '2023-04-28'), ('approved', '2023-04-29'), ('approved', '2023-04-30'), ('delivered', '2023-05-01'), ('delivered', '2023-05-02'), ('delivered', '2023-05-03'), ('delivered', '2023-05-04'), ('cancelled', '2023-05-05'), ('delivered', '2023-05-06'), ('cancelled', '2023-05-07'), ('delivered', '2023-05-08'), ('cancelled', '2023-05-09'), ('returned', '2023-05-10'), ('delivered', '2023-05-11'), ('approved', '2023-05-12'), ('returned', '2023-05-13'), ('cancelled', '2023-05-14'), ('approved', '2023-05-15'), ('approved', '2023-05-16'), ('approved', '2023-05-17'), ('cancelled', '2023-05-18'), ('approved', '2023-05-19'), ('delivered', '2023-05-20'), ('delivered', '2023-05-21'), ('approved', '2023-05-22'), ('cancelled', '2023-05-23'), ('delivered', '2023-05-24'), ('approved', '2023-05-25'), ('returned', '2023-05-26'), ('approved', '2023-05-27'), ('delivered', '2023-05-28'), ('delivered', '2023-05-29'), ('approved', '2023-05-30'), ('returned', '2023-05-31'), ('delivered', '2023-06-01'), ('cancelled', '2023-06-02'), ('cancelled', '2023-06-03'), ('delivered', '2023-06-04'), ('cancelled', '2023-06-05'), ('cancelled', '2023-06-06'), ('returned', '2023-06-07'), ('returned', '2023-06-08'), ('delivered', '2023-06-09'), ('returned', '2023-06-10'), ('returned', '2023-06-11'), ('delivered', '2023-06-12'), ('approved', '2023-06-13'), ('delivered', '2023-06-14'), ('approved', '2023-06-15'), ('delivered', '2023-06-16'), ('delivered', '2023-06-17'), ('delivered', '2023-06-18'), ('returned', '2023-06-19'), ('approved', '2023-06-20'), ('delivered', '2023-06-21'), ('approved', '2023-06-22'), ('returned', '2023-06-23'), ('cancelled', '2023-06-24'), ('returned', '2023-06-25'), ('returned', '2023-06-26'), ('returned', '2023-06-27'), ('cancelled', '2023-06-28'), ('cancelled', '2023-06-29'), ('approved', '2023-06-30'), ('cancelled', '2023-07-01'), ('delivered', '2023-07-02'), ('delivered', '2023-07-03'), ('cancelled', '2023-07-04'), ('returned', '2023-07-05'), ('approved', '2023-07-06'), ('returned', '2023-07-07'), ('returned', '2023-07-08'), ('cancelled', '2023-07-09'), ('cancelled', '2023-07-10'), ('approved', '2023-07-11'), ('delivered', '2023-07-12'), ('delivered', '2023-07-13'), ('delivered', '2023-07-14'), ('approved', '2023-07-15'), ('delivered', '2023-07-16'), ('returned', '2023-07-17'), ('returned', '2023-07-18'), ('cancelled', '2023-07-19'), ('delivered', '2023-07-20'), ('cancelled', '2023-07-21'), ('delivered', '2023-07-22'), ('cancelled', '2023-07-23'), ('approved', '2023-07-24'), ('delivered', '2023-07-25'), ('approved', '2023-07-26'), ('delivered', '2023-07-27'), ('approved', '2023-07-28'), ('returned', '2023-07-29'), ('returned', '2023-07-30'), ('cancelled', '2023-07-31'), ('approved', '2023-08-01'), ('returned', '2023-08-02'), ('returned', '2023-08-03'), ('returned', '2023-08-04'), ('delivered', '2023-08-05'), ('delivered', '2023-08-06'), ('delivered', '2023-08-07'), ('approved', '2023-08-08'), ('delivered', '2023-08-09'), ('returned', '2023-08-10'), ('cancelled', '2023-08-11'), ('returned', '2023-08-12'), ('delivered', '2023-08-13'), ('returned', '2023-08-14'), ('approved', '2023-08-15'), ('cancelled', '2023-08-16'), ('delivered', '2023-08-17'), ('delivered', '2023-08-18'), ('cancelled', '2023-08-19'), ('approved', '2023-08-20'), ('approved', '2023-08-21'), ('returned', '2023-08-22'), ('returned', '2023-08-23'), ('cancelled', '2023-08-24'), ('cancelled', '2023-08-25'), ('approved', '2023-08-26'), ('cancelled', '2023-08-27'), ('returned', '2023-08-28'), ('returned', '2023-08-29'), ('cancelled', '2023-08-30'), ('cancelled', '2023-08-31'), ('cancelled', '2023-09-01'), ('approved', '2023-09-02'), ('approved', '2023-09-03'), ('delivered', '2023-09-04'), ('cancelled', '2023-09-05'), ('approved', '2023-09-06'), ('cancelled', '2023-09-07'), ('returned', '2023-09-08'), ('returned', '2023-09-09'), ('delivered', '2023-09-10'), ('delivered', '2023-09-11'), ('returned', '2023-09-12'), ('delivered', '2023-09-13'), ('approved', '2023-09-14'), ('returned', '2023-09-15'), ('approved', '2023-09-16'), ('cancelled', '2023-09-17'), ('delivered', '2023-09-18'), ('returned', '2023-09-19'), ('cancelled', '2023-09-20'), ('returned', '2023-09-21'), ('cancelled', '2023-09-22'), ('delivered', '2023-09-23'), ('approved', '2023-09-24'), ('returned', '2023-09-25'), ('approved', '2023-09-26'), ('approved', '2023-09-27'), ('delivered', '2023-09-28'), ('approved', '2023-09-29'), ('returned', '2023-09-30'), ('delivered', '2023-10-01'), ('delivered', '2023-10-02'), ('delivered', '2023-10-03'), ('cancelled', '2023-10-04'), ('returned', '2023-10-05'), ('approved', '2023-10-06'), ('approved', '2023-10-07'), ('cancelled', '2023-10-08'), ('approved', '2023-10-09'), ('delivered', '2023-10-10'), ('delivered', '2023-10-11'), ('approved', '2023-10-12'), ('approved', '2023-10-13'), ('cancelled', '2023-10-14'), ('cancelled', '2023-10-15'), ('cancelled', '2023-10-16'), ('delivered', '2023-10-17'), ('returned', '2023-10-18'), ('approved', '2023-10-19'), ('cancelled', '2023-10-20'), ('approved', '2023-10-21'), ('cancelled', '2023-10-22'), ('cancelled', '2023-10-23'), ('delivered', '2023-10-24'), ('delivered', '2023-10-25'), ('approved', '2023-10-26'), ('delivered', '2023-10-27'), ('approved', '2023-10-28'), ('cancelled', '2023-10-29'), ('cancelled', '2023-10-30'), ('approved', '2023-10-31'), ('delivered', '2023-11-01'), ('returned', '2023-11-02'), ('approved', '2023-11-03'), ('delivered', '2023-11-04'), ('cancelled', '2023-11-05'), ('approved', '2023-11-06'), ('cancelled', '2023-11-07'), ('approved', '2023-11-08'), ('cancelled', '2023-11-09'), ('cancelled', '2023-11-10'), ('delivered', '2023-11-11'), ('cancelled', '2023-11-12'), ('delivered', '2023-11-13'), ('cancelled', '2023-11-14'), ('returned', '2023-11-15'), ('approved', '2023-11-16'), ('cancelled', '2023-11-17'), ('cancelled', '2023-11-18'), ('cancelled', '2023-11-19'), ('delivered', '2023-11-20'), ('returned', '2023-11-21'), ('returned', '2023-11-22'), ('cancelled', '2023-11-23'), ('returned', '2023-11-24'), ('cancelled', '2023-11-25'), ('returned', '2023-11-26'), ('approved', '2023-11-27'), ('returned', '2023-11-28'), ('approved', '2023-11-29'), ('approved', '2023-11-30'), ('delivered', '2023-12-01'), ('returned', '2023-12-02'), ('returned', '2023-12-03'), ('cancelled', '2023-12-04'), ('returned', '2023-12-05'), ('approved', '2023-12-06'), ('approved', '2023-12-07'), ('approved', '2023-12-08'), ('cancelled', '2023-12-09'), ('delivered', '2023-12-10'), ('delivered', '2023-12-11'), ('returned', '2023-12-12'), ('approved', '2023-12-13'), ('approved', '2023-12-14'), ('returned', '2023-12-15'), ('cancelled', '2023-12-16'), ('returned', '2023-12-17'), ('cancelled', '2023-12-18'), ('cancelled', '2023-12-19'), ('delivered', '2023-12-20'), ('returned', '2023-12-21'), ('cancelled', '2023-12-22'), ('delivered', '2023-12-23'), ('approved', '2023-12-24'), ('cancelled', '2023-12-25'), ('returned', '2023-12-26'), ('approved', '2023-12-27'), ('returned', '2023-12-28'), ('cancelled', '2023-12-29'), ('delivered', '2023-12-30'), ('approved', '2023-12-31') ;

with temp as (
select
	monthname(order_date) as month,
    100 * sum(case when order_status = 'returned' then 1 else 0 end) / count(1) as return_rate,
    100 * sum(case when order_status = 'delivered' then 1 else 0 end) / count(1) as deliver_rate,
    100 * sum(case when order_status = 'approved' then 1 else 0 end) / count(1) as approved_rate,
    100 * sum(case when order_status = 'cancelled' then 1 else 0 end) / count(1) as cancelled_rate
from order_fact group by monthname(order_date) ) ,

highest_rate as (select *, greatest(return_rate, deliver_rate, approved_rate, cancelled_rate) as `highest rate` from temp ) ,

highest_status as (
select
	*,
	case when `highest rate` = return_rate then 'returned'
		 when `highest rate` = deliver_rate then 'delivered'
		 when `highest rate` = approved_rate then 'approved'
		 when `highest rate` = cancelled_rate then 'cancelled'
	else '' end as `highest status` 
from
	highest_rate ) ,

summary as ( select `highest status`, count(*) cnt from highest_status group by `highest status`) ,

visual as (select `highest status` order_status, (100.0 * cnt)/(select sum(cnt) from summary) rate from summary group by `highest status` )

select *, repeat('|',rate/5) tally from visual ;